<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>对话式游戏卡</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: white;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* 游戏主容器 */
        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: none; /* 初始隐藏，直到设置完名字 */
        }
        
        /* 背景图片 */
        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: brightness(0.7);
            z-index: 1;
        }
        
        /* 游戏UI层 */
        .ui-layer {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部UI区域 */
        .top-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            height: 60px;
        }
        
        /* 菜单按钮 - 右上角圆形按钮 */
        .menu-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            background-color: rgba(99, 146, 248, 0.7);
        }
        
        .menu-btn i {
            font-size: 24px;
            color: white;
        }
        
        /* 菜单弹窗 */
        .menu-modal {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: rgba(30, 30, 46, 0.95);
            border-radius: 12px;
            padding: 15px 0;
            min-width: 180px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 146, 248, 0.3);
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item:hover {
            background-color: rgba(99, 146, 248, 0.3);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        /* 立绘区域 */
        .character-area {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
        }
        
        .character-img {
            max-height: 80%;
            max-width: 90%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .character-img.active {
            opacity: 1;
        }
        
        /* 对话框 */
        .dialog-box {
            background-color: rgba(99, 146, 248, 0.5); /* 要求的半透明蓝色 */
            border-radius: 20px 20px 0 0;
            padding: 25px;
            min-height: 180px;
            margin: 0 10px 0 10px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 50;
        }
        
        /* 说话人名字 */
        .speaker-name {
            position: absolute;
            top: -20px;
            left: 30px;
            background-color: rgba(99, 146, 248, 0.9);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* 对话框文本 */
        .dialog-text {
            color: white; /* 要求的纯白色 */
            font-size: 20px;
            line-height: 1.6;
            min-height: 100px;
        }
        
        /* 点击继续提示 */
        .click-to-continue {
            text-align: center;
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* 选项区域 */
        .options-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            display: none;
            padding: 20px;
        }
        
        .option-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            color: #6392f8;
        }
        
        .option {
            background-color: rgba(99, 146, 248, 0.3);
            border: 2px solid rgba(99, 146, 248, 0.5);
            border-radius: 15px;
            padding: 18px 25px;
            margin: 10px 0;
            width: 90%;
            max-width: 500px;
            cursor: pointer;
            font-size: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .option:hover {
            background-color: rgba(99, 146, 248, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 所有弹窗的通用样式 */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        
        .modal-content {
            background-color: rgba(30, 30, 46, 0.95);
            border-radius: 20px;
                        padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(99, 146, 248, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #6392f8;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(99, 146, 248, 0.5);
            border-radius: 10px;
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #6392f8;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: #6392f8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4a7df5;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(99, 146, 248, 0.4);
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* 存档/读档界面 */
        .save-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .save-slot {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .save-slot:hover {
            background-color: rgba(99, 146, 248, 0.2);
            border-color: rgba(99, 146, 248, 0.5);
        }
        
        .save-slot.active {
            border-color: #6392f8;
            background-color: rgba(99, 146, 248, 0.2);
        }
        
        .save-time {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .save-content {
            font-size: 16px;
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .empty-slot {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px 0;
        }
    </style>
</head>
<body>
    <!-- 姓名设置弹窗（首次进入显示） -->
    <div id="name-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">欢迎来到故事世界</h2>
            <p style="margin-bottom: 20px; text-align: center; line-height: 1.5;">在开始冒险之前，请先为你的角色取一个名字</p>
            <input type="text" id="player-name" class="modal-input" placeholder="请输入角色名字" maxlength="10">
            <div class="btn-group">
                <button id="confirm-name" class="btn btn-primary">开始游戏</button>
            </div>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div id="game-container">
        <!-- 背景图片 -->
        <div class="background"></div>
        
        <!-- UI层 -->
        <div class="ui-layer">
            <!-- 顶部UI区域 -->
            <div class="top-ui">
                <!-- 菜单按钮 -->
                <div id="menu-btn" class="menu-btn">
                    <i class="fas fa-bars"></i>
                </div>
                
                <!-- 菜单弹窗 -->
                <div id="menu-modal" class="menu-modal">
                    <div id="save-btn" class="menu-item">
                        <i class="fas fa-save"></i>
                        <span>存档</span>
                    </div>
                    <div id="load-btn" class="menu-item">
                        <i class="fas fa-folder-open"></i>
                        <span>读档</span>
                    </div>
                    <div id="rename-btn" class="menu-item">
                        <i class="fas fa-user-edit"></i>
                        <span>重命名</span>
                    </div>
                </div>
            </div>
            
            <!-- 立绘区域 -->
            <div class="character-area">
                <!-- 立绘图片，默认显示一个喜欢的立绘 -->
                <img id="character-img" class="character-img active" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="角色立绘">
            </div>
            
            <!-- 对话框 -->
            <div id="dialog-box" class="dialog-box">
                <div id="speaker-name" class="speaker-name">系统</div>
                <div id="dialog-text" class="dialog-text">欢迎来到故事世界！</div>
                <div class="click-to-continue">点击对话框继续</div>
            </div>
        </div>
        
        <!-- 选项选择界面 -->
        <div id="options-container" class="options-container">
            <h2 id="option-title" class="option-title">请做出选择</h2>
            <div id="options-list" class="options-list">
                <!-- 选项会通过JS动态添加到这里 -->
            </div>
        </div>
    </div>
    
    <!-- 存档弹窗 -->
    <div id="save-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">选择存档位置</h2>
            <p style="margin-bottom: 20px; text-align: center;">选择一个位置保存当前游戏进度</p>
            <div id="save-slots" class="save-slots">
                <!-- 存档位会通过JS动态添加 -->
            </div>
            <div class="btn-group" style="margin-top: 25px;">
                <button id="confirm-save" class="btn btn-primary">确认存档</button>
                <button id="cancel-save" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 读档弹窗 -->
    <div id="load-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">选择存档读取</h2>
            <p style="margin-bottom: 20px; text-align: center;">选择一个存档加载游戏进度</p>
            <div id="load-slots" class="save-slots">
                <!-- 存档位会通过JS动态添加 -->
            </div>
            <div class="btn-group" style="margin-top: 25px;">
                <button id="confirm-load" class="btn btn-primary">确认读取</button>
                <button id="cancel-load" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 重命名弹窗 -->
    <div id="rename-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">重命名角色</h2>
            <p style="margin-bottom: 20px; text-align: center;">请输入新的角色名字</p>
            <input type="text" id="new-player-name" class="modal-input" placeholder="请输入新的角色名字" maxlength="10">
            <div class="btn-group">
                <button id="confirm-rename" class="btn btn-primary">确认修改</button>
                <button id="cancel-rename" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏数据管理对象
        const GameData = {
            // 玩家姓名
            playerName: "旅行者",
            
            // 当前游戏状态
            currentState: {
                dialogueIndex: 0, // 当前对话索引
                branch: "start",  // 当前分支
                characterVisible: true, // 立绘是否显示
                characterImage: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" // 当前立绘
            },
            
            // 存档数据（使用本地存储模拟）
            saveSlots: new Array(6).fill(null),
            
            // 初始化存档
            initSaves: function() {
                const saves = localStorage.getItem("dialogueGameSaves");
                if (saves) {
                    this.saveSlots = JSON.parse(saves);
                }
            },
            
            // 保存存档
            saveToSlot: function(slotIndex) {
                if (slotIndex >= 0 && slotIndex < this.saveSlots.length) {
                    const saveData = {
                        playerName: this.playerName,
                        state: {...this.currentState},
                        timestamp: new Date().toLocaleString()
                    };
                    
                    this.saveSlots[slotIndex] = saveData;
                    localStorage.setItem("dialogueGameSaves", JSON.stringify(this.saveSlots));
                    return true;
                }
                return false;
            },
            
            // 读取存档
                        loadFromSlot: function(slotIndex) {
                if (slotIndex >= 0 && slotIndex < this.saveSlots.length && this.saveSlots[slotIndex]) {
                    const saveData = this.saveSlots[slotIndex];
                    this.playerName = saveData.playerName;
                    this.currentState = {...saveData.state};
                    return true;
                }
                return false;
            }
        };
        
        // 游戏对话数据
        const GameDialogue = {
            // 对话数据，按分支组织
            dialogues: {
                // 起始分支
                start: [
                    { 
                        speaker: "系统", 
                        text: "欢迎来到故事世界！请为你的角色取一个名字。", 
                        character: null, // 系统消息没有立绘
                        options: null // 没有选项
                    },
                    { 
                        speaker: "系统", 
                        text: "你好，{PLAYER_NAME}！欢迎来到这个神秘的世界。我是你的向导，将引导你完成这次冒险。", 
                        character: null,
                        options: null
                    },
                    { 
                        speaker: "神秘人", 
                        text: "{PLAYER_NAME}，你终于来了。我已经等你很久了。", 
                        character: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        options: null
                    },
                    { 
                        speaker: "神秘人", 
                        text: "这个世界正面临一场危机，我们需要你的帮助。但在开始之前，我必须了解你的性格。", 
                        character: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        options: [
                            { text: "我是一名勇者，喜欢直面挑战！", nextBranch: "brave" },
                            { text: "我是一名智者，喜欢用智慧解决问题", nextBranch: "wise" },
                            { text: "我只是个普通人，不想卷入麻烦", nextBranch: "normal" }
                        ]
                    }
                ],
                
                // 勇敢分支
                brave: [
                    { 
                        speaker: "神秘人", 
                        text: "很好，{PLAYER_NAME}！勇敢是你的品质。前方有一条巨龙守护着宝藏，你打算怎么做？", 
                        character: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "你选择了勇敢的道路，现在面临与巨龙的战斗选择。", 
                        character: null,
                        options: [
                            { text: "直接挑战巨龙！", nextBranch: "dragon_fight" },
                            { text: "寻找其他方法绕过巨龙", nextBranch: "dragon_avoid" }
                        ]
                    }
                ],
                
                // 智慧分支
                wise: [
                    { 
                        speaker: "神秘人", 
                        text: "智慧是强大的武器，{PLAYER_NAME}。我们发现了一个古老的谜题，需要你的智慧来解开。", 
                        character: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "你选择了智者的道路，现在面临一个古老谜题。", 
                        character: null,
                        options: [
                            { text: "仔细研究谜题的文字线索", nextBranch: "puzzle_study" },
                            { text: "寻找环境中的隐藏提示", nextBranch: "puzzle_search" }
                        ]
                    }
                ],
                
                 // 普通人分支
                normal: [
                    { 
                        speaker: "神秘人", 
                        text: "我理解，{PLAYER_NAME}。但有时命运会选择我们，而不是我们选择命运。", 
                        character: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "你选择了普通人的道路，但仍然面临选择。", 
                        character: null,
                        options: [
                            { text: "尽管害怕，但还是决定帮助", nextBranch: "help_despite_fear" },
                            { text: "坚持不卷入危险，选择离开", nextBranch: "leave_danger" }
                        ]
                    }
                ],
                
                // 各种结局
                dragon_fight: [
                    { 
                        speaker: "系统", 
                        text: "你勇敢地挑战巨龙，经过激烈战斗，你成功击败了巨龙，获得了宝藏！", 
                        character: null,
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "恭喜{PLAYER_NAME}，你完成了这次冒险！点击对话框重新开始。", 
                        character: null,
                        options: null
                    }
                ],
                
                dragon_avoid: [
                    { 
                        speaker: "系统", 
                        text: "你寻找其他路径，发现了一条秘密通道，成功绕过了巨龙，获得了宝藏！", 
                        character: null,
                        options: null
                    },
                    { 
                    
                      speaker: "系统", 
                        text: "恭喜{PLAYER_NAME}，你完成了这次冒险！点击对话框重新开始。", 
                        character: null,
                        options: null
                    }
                ],
                
                puzzle_study: [
                    { 
                        speaker: "系统", 
                        text: "你仔细研究谜题，成功解开了古老谜题，获得了智慧之书！", 
                        character: null,
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "恭喜{PLAYER_NAME}，你完成了这次冒险！点击对话框重新开始。", 
                        character: null,
                        options: null
                    }
                ],
                
                help_despite_fear: [
                    { 
                        speaker: "系统", 
                        text: "尽管害怕，你还是决定帮助，你的勇气感动了众人，他们赠予你友谊之证！", 
                        character: null,
                        options: null
                    },
                    { 
                        speaker: "系统", 
                        text: "恭喜{PLAYER_NAME}，你完成了这次冒险！点击对话框重新开始。", 
                        character: null,
                        options: null
                    }
                ],
                
                // 游戏结束分支
                game_end: [
                    { 
                        speaker: "系统", 
                        text: "游戏结束！你已经完成了所有剧情。点击对话框重新开始游戏。", 
                        character: null,
                        options: null
                    }
                ]
            },
            
            // 获取当前对话
            getCurrentDialogue: function() {
                const branch = GameData.currentState.branch;
                const index = GameData.currentState.dialogueIndex;
                
                if (this.dialogues[branch] && index < this.dialogues[branch].length) {
                    return this.dialogues[branch][index];
                }
                return null;
            },
            
             // 前进到下一句对话
            nextDialogue: function() {
                const branch = GameData.currentState.branch;
                const index = GameData.currentState.dialogueIndex;
                
                // 如果当前对话有选项，不自动前进
                const current = this.getCurrentDialogue();
                if (current && current.options) {
                    return false;
                }
                
                // 检查是否有更多对话
                if (this.dialogues[branch] && index + 1 < this.dialogues[branch].length) {
                    GameData.currentState.dialogueIndex++;
                    return true;
                } else {
                    // 对话结束，检查是否是最终分支
                    if (branch === "game_end" || branch.startsWith("dragon_") || branch.startsWith("puzzle_") || branch === "help_despite_fear" || branch === "leave_danger") {
                        // 如果是结局分支，跳转到游戏结束
                        GameData.currentState.branch = "game_end";
                        GameData.currentState.dialogueIndex = 0;
                        return true;
                    }
                    return false;
                }
            },
            
            // 选择选项
            selectOption: function(optionIndex) {
                const current = this.getCurrentDialogue();
                if (current && current.options && optionIndex < current.options.length) {
                    const selectedOption = current.options[optionIndex];
                    
                    // 更新分支和重置对话索引
                    GameData.currentState.branch = selectedOption.nextBranch;
                    GameData.currentState.dialogueIndex = 0;
                    
                    return true;
                }
                return false;
            }
        };
        
         // DOM元素引用
        const domElements = {
            // 弹窗
            nameModal: document.getElementById("name-modal"),
            gameContainer: document.getElementById("game-container"),
            
            // 菜单相关
            menuBtn: document.getElementById("menu-btn"),
            menuModal: document.getElementById("menu-modal"),
            saveBtn: document.getElementById("save-btn"),
            loadBtn: document.getElementById("load-btn"),
            renameBtn: document.getElementById("rename-btn"),
            
            // 存档/读档弹窗
            saveModal: document.getElementById("save-modal"),
            loadModal: document.getElementById("load-modal"),
            renameModal: document.getElementById("rename-modal"),
            
            // 游戏界面
            speakerName: document.getElementById("speaker-name"),
            dialogText: document.getElementById("dialog-text"),
            dialogBox: document.getElementById("dialog-box"),
            characterImg: document.getElementById("character-img"),
            
            // 选项界面
            optionsContainer: document.getElementById("options-container"),
            optionsList: document.getElementById("options-list"),
            optionTitle: document.getElementById("option-title")
        };
        
        // 游戏状态
        let selectedSaveSlot = -1;
        
        // 初始化游戏
        function initGame() {
            // 初始化存档数据
            GameData.initSaves();
            
            // 设置玩家名字
            const playerNameInput = document.getElementById("player-name");
            const confirmNameBtn = document.getElementById("confirm-name");
            
            // 确认名字按钮事件
            confirmNameBtn.addEventListener("click", () => {
                const name = playerNameInput.value.trim();
                if (name) {
                    GameData.playerName = name;
                    domElements.nameModal.style.display = "none";
                    domElements.gameContainer.style.display = "block";
                    updateDialogue();
                } else {
                    alert("请输入角色名字！");
                }
            });
            
              // 回车键确认名字
            playerNameInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    confirmNameBtn.click();
                }
            });
            
            // 菜单按钮事件
            domElements.menuBtn.addEventListener("click", () => {
                const isVisible = domElements.menuModal.style.display === "block";
                domElements.menuModal.style.display = isVisible ? "none" : "block";
            });
            
            // 存档按钮事件
            domElements.saveBtn.addEventListener("click", () => {
                domElements.menuModal.style.display = "none";
                showSaveModal();
            });
            
            // 读档按钮事件
            domElements.loadBtn.addEventListener("click", () => {
                domElements.menuModal.style.display = "none";
                showLoadModal();
            });
            
            // 重命名按钮事件
            domElements.renameBtn.addEventListener("click", () => {
                domElements.menuModal.style.display = "none";
                showRenameModal();
            });
            
            // 对话框点击事件（点击继续）
            domElements.dialogBox.addEventListener("click", () => {
                // 如果选项界面显示中，不响应点击
                if (domElements.optionsContainer.style.display === "flex") {
                    return;
                }
                
                // 前进到下一句对话
                if (GameDialogue.nextDialogue()) {
                    updateDialogue();
                } else {
                    // 如果没有更多对话，重新开始游戏
                    GameData.currentState.branch = "start";
                    GameData.currentState.dialogueIndex = 0;
                    updateDialogue();
                }
            });
            
            // 关闭菜单当点击其他地方
            document.addEventListener("click", (e) => {
                if (!domElements.menuBtn.contains(e.target) && !domElements.menuModal.contains(e.target)) {
                    domElements.menuModal.style.display = "none";
                }
            });
            
            // 初始化弹窗事件
            initModals();
            
              // 设置默认立绘
            domElements.characterImg.src = GameData.currentState.characterImage;
        }
        
        // 初始化弹窗事件
        function initModals() {
            // 存档弹窗
            const cancelSaveBtn = document.getElementById("cancel-save");
            const confirmSaveBtn = document.getElementById("confirm-save");
            
            cancelSaveBtn.addEventListener("click", () => {
                domElements.saveModal.style.display = "none";
            });
            
            confirmSaveBtn.addEventListener("click", () => {
                if (selectedSaveSlot >= 0) {
                    GameData.saveToSlot(selectedSaveSlot);
                    domElements.saveModal.style.display = "none";
                    selectedSaveSlot = -1;
                    alert("存档成功！");
                } else {
                    alert("请选择一个存档位！");
                }
            });
            
            // 读档弹窗
            const cancelLoadBtn = document.getElementById("cancel-load");
            const confirmLoadBtn = document.getElementById("confirm-load");
            
            cancelLoadBtn.addEventListener("click", () => {
                domElements.loadModal.style.display = "none";
            });
            
            confirmLoadBtn.addEventListener("click", () => {
                if (selectedSaveSlot >= 0) {
                    if (GameData.loadFromSlot(selectedSaveSlot)) {
                        domElements.loadModal.style.display = "none";
                        selectedSaveSlot = -1;
                        updateDialogue();
                        alert("读档成功！");
                    } else {
                        alert("该存档位为空！");
                    }
                } else {
                    alert("请选择一个存档！");
                }
            });
            
               // 重命名弹窗
            const cancelRenameBtn = document.getElementById("cancel-rename");
            const confirmRenameBtn = document.getElementById("confirm-rename");
            const newPlayerNameInput = document.getElementById("new-player-name");
            
            cancelRenameBtn.addEventListener("click", () => {
                domElements.renameModal.style.display = "none";
            });
            
            confirmRenameBtn.addEventListener("click", () => {
                const newName = newPlayerNameInput.value.trim();
                if (newName) {
                    GameData.playerName = newName;
                    domElements.renameModal.style.display = "none";
                    updateDialogue();
                    alert("名字修改成功！");
                } else {
                    alert("请输入新的角色名字！");
                }
            });
        }
        
        // 显示存档弹窗
        function showSaveModal() {
            domElements.saveModal.style.display = "flex";
            selectedSaveSlot = -1;
            
            const saveSlotsContainer = document.getElementById("save-slots");
            saveSlotsContainer.innerHTML = "";
            
            // 创建6个存档位
            for (let i = 0; i < 6; i++) {
                const slot = document.createElement("div");
                slot.className = "save-slot";
                slot.dataset.index = i;
                
                const saveData = GameData.saveSlots[i];
                
                if (saveData) {
                    slot.innerHTML = `
                        <div style="font-weight: bold;">存档位 ${i + 1}</div>
                        <div class="save-time">${saveData.timestamp}</div>
                        <div class="save-content">${saveData.playerName} - ${saveData.state.branch}</div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div style="font-weight: bold;">存档位 ${i + 1}</div>
                        <div class="empty-slot">空存档位</div>
                    `;
                }
                
                 // 点击选择存档位
                slot.addEventListener("click", () => {
                    // 移除所有存档位的激活状态
                    document.querySelectorAll(".save-slot").forEach(s => s.classList.remove("active"));
                    // 激活当前选择的存档位
                    slot.classList.add("active");
                    selectedSaveSlot = i;
                });
                
                saveSlotsContainer.appendChild(slot);
            }
        }
        
        // 显示读档弹窗
        function showLoadModal() {
            domElements.loadModal.style.display = "flex";
            selectedSaveSlot = -1;
            
            const loadSlotsContainer = document.getElementById("load-slots");
            loadSlotsContainer.innerHTML = "";
            
            // 创建6个存档位
            for (let i = 0; i < 6; i++) {
                const slot = document.createElement("div");
                slot.className = "save-slot";
                slot.dataset.index = i;
                
                const saveData = GameData.saveSlots[i];
                
                if (saveData) {
                    slot.innerHTML = `
                        <div style="font-weight: bold;">存档位 ${i + 1}</div>
                        <div class="save-time">${saveData.timestamp}</div>
                        <div class="save-content">${saveData.playerName} - ${saveData.state.branch}</div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div style="font-weight: bold;">存档位 ${i + 1}</div>
                        <div class="empty-slot">空存档位</div>
                    `;
                }
                
                // 只有有存档的位才能点击
                if (saveData) {
                    slot.style.cursor = "pointer";
                    slot.addEventListener("click", () => {
                        // 移除所有存档位的激活状态
                        document.querySelectorAll(".save-slot").forEach(s => s.classList.remove("active"));
                        // 激活当前选择的存档位
                        slot.classList.add("active");
                        selectedSaveSlot = i;
                    });
                } else {
                    slot.style.cursor = "not-allowed";
                    slot.style.opacity = "0.6";
                }
                
                loadSlotsContainer.appendChild(slot);
            }
        }
        
          // 显示重命名弹窗
        function showRenameModal() {
            domElements.renameModal.style.display = "flex";
            document.getElementById("new-player-name").value = GameData.playerName;
        }
        
        // 更新对话框内容
        function updateDialogue() {
            const dialogue = GameDialogue.getCurrentDialogue();
            
            if (!dialogue) {
                // 如果没有更多对话，重新开始
                GameData.currentState.branch = "start";
                GameData.currentState.dialogueIndex = 0;
                updateDialogue();
                return;
            }
            
            // 更新说话人名字
            domElements.speakerName.textContent = dialogue.speaker;
            
            // 更新对话框文本，替换{PLAYER_NAME}为玩家名字
            let text = dialogue.text;
            text = text.replace(/{PLAYER_NAME}/g, GameData.playerName);
            domElements.dialogText.textContent = text;
            
            // 更新立绘
            if (dialogue.character) {
                domElements.characterImg.src = dialogue.character;
                domElements.characterImg.classList.add("active");
                GameData.currentState.characterVisible = true;
            } else {
                domElements.characterImg.classList.remove("active");
                GameData.currentState.characterVisible = false;
            }
            
            // 更新立绘图片状态
            GameData.currentState.characterImage = dialogue.character || "";
            
            // 如果有选项，显示选项界面
            if (dialogue.options && dialogue.options.length > 0) {
                showOptions(dialogue.options);
            } else {
                // 隐藏选项界面
                domElements.optionsContainer.style.display = "none";
            }
        }
        
        // 显示选项
        function showOptions(options) {
            // 显示选项容器
            domElements.optionsContainer.style.display = "flex";
            domElements.optionTitle.textContent = "请做出选择";
            
               // 清空选项列表
            domElements.optionsList.innerHTML = "";
            
            // 添加选项
            options.forEach((option, index) => {
                const optionElement = document.createElement("div");
                optionElement.className = "option";
                optionElement.textContent = option.text.replace(/{PLAYER_NAME}/g, GameData.playerName);
                
                // 选项点击事件
                optionElement.addEventListener("click", () => {
                    // 选择选项
                    GameDialogue.selectOption(index);
                    // 隐藏选项界面
                    domElements.optionsContainer.style.display = "none";
                    // 更新对话
                    updateDialogue();
                });
                
                domElements.optionsList.appendChild(optionElement);
            });
        }
        
        // 页面加载完成后初始化游戏
        document.addEventListener("DOMContentLoaded", initGame);
    </script>
</body>
</html>
